<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Editable Tree - jQuery EasyUI Demo</title>
    <link rel="stylesheet" type="text/css" href="../../easyui/1.3.4/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="../../easyui/1.3.4/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../../easyui/1.3.4/demo/demo.css">
    <link rel="stylesheet" type="text/css" href="../../css/skin.css">
    <script type="text/javascript" src="../../js/jquery-1.8.0.min.js"></script>
    <script type="text/javascript" src="../../easyui/1.3.4/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../easyui/1.3.4/locale/easyui-lang-zh_CN.js"></script>
    <script src="../../kindeditor/kindeditor-all.js"></script>
    <script src="../../kindeditor/kindeditor-all-min.js"></script>
    <script charset="utf-8" src="../../kindeditor/lang/zh-CN.js"></script>
    <style>
        .uploadImgBtn {
            width: 47px;
            height: 30px;
            cursor: pointer;
            position: relative;
            background: url("upload.png") no-repeat;
            -webkit-background-size: cover;
            background-size: cover;
        }

        .uploadImgBtn .uploadImg {
            position: absolute;
            right: 0;
            top: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .pic {
            width: 100px;
            height: 100px;
        }

        .pic img {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
<!--陈士鹏开始-->
<form id="ff" class="easyui-form" method="post" data-options="novalidate:true">
    <table cellpadding="5" width="100%">
        <tr class="margin_10_0">
            <td class="w_20 text_right">所属菜单:</td>
            <td class="w_80">
                <select class="easyui-combobox w_20" name="language">
                    <option value="th">Thai</option><option value="tr">Turkish</option><option value="uk">Ukrainian</option><option value="vi">Vietnamese</option></select></td>
        </tr>
        <tr class="margin_10_0">
            <td class="w_20 text_right">标题:</td>
            <td class="w_80"><input class="easyui-textbox w_50" type="text" name="email" data-options="required:true,validType:'email'"></input></td>
        </tr>
        <tr class="margin_10_0">
            <td class="w_20 text_right">描述:</td>
            <td class="w_80"><textarea id="" rows=5 name="" class="textarea easyui-validatebox w_50"></textarea></td>
        </tr>
        <tr class="margin_10_0">
            <td class="w_20 text_right">类型:</td>
            <td class="w_80"><input class="easyui-textbox w_50" name="message" data-options="multiline:true" style="height:60px"></input></td>
        </tr>
        <tr class="margin_10_0">
            <td class="w_20 text_right">类别:</td>
            <td class="w_80">
                <input  type="radio" name="consuType" class="easyui-validatebox" checked="checked" value="00"><label>手动编辑</label></input>
                <input  type="radio" name="consuType"class="easyui-validatebox" value="01"><label>外链</label></input>
            </td>
        </tr>
        <tr class="margin_10_0">
            <td class="w_20 text_right">位置:</td>
            <td class="w_80">
                <select class="easyui-combobox" name="language"><option value="ar">Arabic</option><option value="bg">Bulgarian</option><option value="ca">Catalan</option><option value="zh-cht">Chinese Traditional</option><option value="cs">Czech</option><option value="da">Danish</option><option value="nl">Dutch</option><option value="en" selected="selected">English</option><option value="et">Estonian</option><option value="fi">Finnish</option><option value="fr">French</option><option value="de">German</option><option value="el">Greek</option><option value="ht">Haitian Creole</option><option value="he">Hebrew</option><option value="hi">Hindi</option><option value="mww">Hmong Daw</option><option value="hu">Hungarian</option><option value="id">Indonesian</option><option value="it">Italian</option><option value="ja">Japanese</option><option value="ko">Korean</option><option value="lv">Latvian</option><option value="lt">Lithuanian</option><option value="no">Norwegian</option><option value="fa">Persian</option><option value="pl">Polish</option><option value="pt">Portuguese</option><option value="ro">Romanian</option><option value="ru">Russian</option><option value="sk">Slovak</option><option value="sl">Slovenian</option><option value="es">Spanish</option><option value="sv">Swedish</option><option value="th">Thai</option><option value="tr">Turkish</option><option value="uk">Ukrainian</option><option value="vi">Vietnamese</option></select>
            </td>
        </tr>
        <tr class="margin_10_0">
            <td class="w_20 text_right">文章内容:</td>
            <td class="w_80">
                <textarea rows="3"  id="context" name="context" class="easyui-validatebox w_70" data-options="required:true,validType:'length[1,1000000]'" invalidMessage="最大长度不能超过1000000"></textarea>
            </td>
        </tr>
        <tr class="margin_10_0">
            <td class="w_20 text_right">备注:</td>
            <td class="w_80">
                <textarea id="" rows=5 name="" class="textarea easyui-validatebox w_50"></textarea>
            </td>
        </tr>
        <tr class="margin_10_0">
            <td class="w_20 text_right">图片上传:</td>
            <td class="w_80">
                <div class="uploadImgBtn" id="uploadImgBtn1">
                    <input class="uploadImg" type="file" name="file" id="file1">
                </div>
            </td>
        </tr>
    </table>
</form>
<div style="text-align:center;padding:5px">
    <a href="javascript:void(0)" class="easyui-linkbutton" onclick="submitForm()">提交</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" onclick="clearForm()">取消</a>
</div>
<!--陈士鹏结束-->
<!--<div style="margin:10px 0;">
    <form id="fm" method="post" style="margin-top: 20px; margin-left: 20px;" action="/management/consultation/updateConsultation">
        <input id="consulId" name="consulId"  type="hidden"  class="easyui-textbox" editable="false" />
        <div class="fitem">
            <label>所属菜单:</label>
            <input  id="columnId" name="columnId" style="" style="width: 160px; height: 65px;" class="easyui-combobox" editable="false"  data-options="required:true"/>
        </div>
        <input id ="images" name="images" type='hidden' class="easyui-textbox" editable="false" />
        <div class="fitem">
            <label>标题:</label>
            <input id="title" name="title" class="easyui-textbox" editable="false" />
        </div>

        <div class="fitem">
            <label>描述:</label>
            <input  id="consuDesc" name="consuDesc" class="easyui-textbox" editable="false" />
        </div>

        <div class="fitem">
            <label>类型:</label>
            <input  type="radio" name="consuType"
                    class="easyui-validatebox" checked="checked" value="00" onclick="check('d1')"><label>手动编辑</label></input>
            <input  type="radio" name="consuType"
                    class="easyui-validatebox" value="01" onclick="check('d2')"><label>外链</label></input>
        </div>

        <div class="fitem">
            <label>类别:</label>
            <input  id="consuClass" name="consuClass" style="width: 160px; height: 65px;" class="easyui-combobox" editable="false"  data-options="required:true"/>
        </div>
        <div class="fitem">
            <label>位置:</label>
            <input  id="consuPlace" name="consuPlace" style="width: 160px; height: 65px;" style="width: 160px; height: 65px;" class="easyui-combobox" editable="false"  data-options="required:true"/>
        </div>
        <div class="fitem" id="consuLink_div">
            <label>链接:</label>
            <input   id="consuLink" name="consuLink" style="width: 160px; height: 65px;" class="easyui-textbox" data-options="multiline:true" />
        </div>
        <div class="fitem" id="context_div">
            <label>文章内容:</label>
            <textarea rows="3" style="width:400px;" id="context" name="context" class="easyui-validatebox" data-options="required:true,validType:'length[1,1000000]'" invalidMessage="最大长度不能超过1000000"></textarea>
        </div>
        <div class="fitem">
            <label>备注:</label>
            <input  id="remarks"  name="remarks" style="width: 160px; height: 65px;" class="easyui-textbox" data-options="multiline:true" />
        </div>

    </form>
    <div id="formBox">
    </div>
    <div id="dlg-buttons1" style="display: block">
        <a id="confirm1" href="javascript:void(0)" class="easyui-linkbutton c6" iconcls="icon-ok" onclick="updateConsultation()" style="width: 90px">提交</a>
    </div>
</div>-->
<script>
        var editor;
        var count=0;
        $(function() {
            editor = KindEditor.create('textarea[name="context"]',{
                resizeType : 1,
                width:"100%",
                height:"200px",
                allowPreviewEmoticons:false,
                allowImageUpload:true,//允许上传图片
                allowFileManager:true, //允许对上传图片进行管理
                uploadJson:'/management/consultation/uploadImg.do', //上传图片的java代码，只不过放在jsp中
                fileManagerJson:'../../kindeditor/jsp/file_manager_json.jsp',
                afterUpload:function(){this.sync();}, //图片上传后，将上传内容同步到textarea中
                afterBlur:function(){this.sync();},   ////失去焦点时，将上传内容同步到textarea中
                items : [
                    'fontname','fontsize',
                    '|','forecolor',
                    'hilitecolor','bold',
                    'italic','underline',
                    'removeformat','|',
                    'justifyleft','justifycenter',
                    'justifyright','insertorderedlist',
                    'insertunorderedlist','|',
                    'emoticons','link','media','|','image'],
                afterChange:function(){
                    this.sync();
                },
                afterBlur:function(){
                    this.sync();
                }
            });
        var url = location.search;
        var consuId;
        if (url.indexOf("?") != -1) {
            var site = url.lastIndexOf("=");
            consuId=url.substring(site + 1, url.length);
        }
        voluation(consuId);
        qryApppar("consultation_columnId","columnId");
        qryApppar("consultation_consuClass","consuClass");
        qryApppar("consultation_consuPlace","consuPlace");
    });

    function voluation(consuId){
            alert(consuId);
        $.ajax({
            url:'/management/consultation/qryConsultationById',
            type:"POST",
            async:false,
            data:{consulId:consuId},
            success:function(data){
                /*return rows;*/
                alert(data);
               // $("#columnId").val(data.columnId);
                $('#columnId').combobox('select',data.columnId);
                $("#consulId").val(data.consulId);
                $("#title").val(data.title);
                $("#consuDesc").val(data.consuDesc);
                alert("data.consuType"+data.consuType);
                debugger;
                if (data.consuType == "00") {
                    alert(11);
                    $("input[name='consuType'][value='00']").attr("checked",true);
                    KindEditor.html("#context", data.context);
                    $('#consuLink_div').css("display",'none');
                }else if(data.consuType== "01"){
                    $("input[name='consuType'][value='01']").attr("checked",true);
                    $("#consuLink").val(data.consuLink);
                    $('#context_div').css("display",'none');
                }
                $('#consuClass').combobox('select',data.consuClass);
                $('#consuPlace').combobox('select',data.consuPlace);
                $("#remarks").val(data.remarks);
                addForm(data.images);
            }
        });
    }

    function updateConsultation() {
        var imageUrl='';
            var myDiv = document.getElementById("uploadImgBtn1");
            if(myDiv==null){
                alert(1);
            }else{
                var style=myDiv.style;
                alert(style.backgroundImage.substring(5,style.backgroundImage.length-2));//red

                imageUrl+=style.backgroundImage.substring(5,style.backgroundImage.length-2)+',';
            }
        alert(imageUrl.substring(0,imageUrl.length-1));
        $("#images").val(imageUrl.substring(0,imageUrl.length-1));
        fm.submit();
    }
    function addForm(images) {
      /*  var img=[];
        img =images.split(",");*/
            var image = images;
            var str = '<form id="formTag1" enctype="multipart/form-data">'+
                '<div class="uploadImgBtn" id="uploadImgBtn1" style="background-image: url('+image+');">'+
                '<input class="uploadImg" type="file" name="file" id="file1">'+
                '</div>'+
                '</form>   ';
            $("#formBox").append($(str));
            $("#file1").on("change", upload );
/*
        count=img.length+1;
        for(var i=0;i<img.length;i++){
            var image = img[i];
            console.info(img)
            var str = '<form id="formTag'+(i+1)+'" enctype="multipart/form-data">'+
                '<div class="uploadImgBtn" id="uploadImgBtn'+(i+1)+'" style="background-image: url('+image+');">'+
                '<input class="uploadImg" type="file" name="file" id="file'+(i+1)+'">'+
                '</div>'+
                '</form>   ';

           /!* var str='<form id="formTag1" enctype="multipart/form-data">'+
                '<div class="uploadImgBtn" id="uploadImgBtn1" style="background-image: url('+img+');">'+
                '<input class="uploadImg" type="file" name="file" id="file1">'+
                '</div>'+
                '</form>';*!/
           /!* $("#uploadImgBtn"+(i+1)).css({
                "background-image": "url("+img[i]+")"
            });*!/
           /!* var img_Url=img[i];
            alert("111111-"+img_Url);
            $("file"+(i+1)).parent().css({
                "background-image": "http://localhost:8001/management/Upload/201810/21-002318_6914_kpuhh9euE6.jpg"
            });*!/
            $("#formBox").append($(str));
            $("#file"+(i+1)).on("change", upload );
        }
*/
      /*  var pk = 'http://localhost:8001/management/html/consultation/pk.jpg';
        var str1= '<form id="formTag'+(img.length+1)+'" enctype="multipart/form-data">'+
        '<div class="uploadImgBtn" style="background-image: url('+pk+')" id="uploadImgBtn'+(img.length+1)+'">'+
        '<input class="uploadImg" type="file" name="file" id="file'+(img.length+1)+'">'+
        '</div>'+
        '</form>   ';
        $("#formBox").append($(str1));
        var $sel = "#file"+(img.length+1);
        //为新生成的input绑定change事件
        $($sel).on("change", upload );*/
    }
        function upload(){
            var self = this;

            //获得它是第几个form表单
            var num = this.getAttribute("id").replace(/[a-zA-Z]/g,"");
            //构造form的选择器
            var $form = "#formTag" +num;
            alert("num++__+"+num);
            $.ajax({
                url:"/management/consultation/uploadImg.do",
                type:"post",
                dataType:"json",
                cache:false,
                data: new FormData($($form)[0]),
                processData: false,// 不处理数据
                contentType: false, // 不设置内容类型
                success:function(data){
                    //设置背景为我们选择的图片
                    $(self).parent().css({
                        "background-image": "url("+data.url+")"
                    });
                    //imgurl+=data.url;
                    // $("#images").val(imgurl);
                    //我们再生成一个form
                    if(count == num ){
                        //count计数加1
                        count +=1;
                        var str = '<form id="formTag'+count+'" enctype="multipart/form-data">'+
                            '<div class="uploadImgBtn" id="uploadImgBtn'+count+'">'+
                            '<input class="uploadImg" type="file" name="file" id="file'+count+'">'+
                            '</div>'+
                            '</form>   ';
                        //向最外面的盒子添加form
                        $("#formBox").append($(str));
                        //构造input的选择器
                        var $sel = "#file"+count;
                        //为新生成的input绑定change事件
                        $($sel).on("change", upload );

                    }else{
                        //如果不等于
                        return false;
                    }
                }
            });
        }
        function qryApppar(a,b) {
            $.ajax({
                type: "POST",
                url: "/management/consultation/qryApppar.do",
                data: {code:a},
                //contentType: "application/json; charset=utf-8",//去掉这个就可以实现了,为什么呢？？？
                dataType: "json",
                success: function (response) {//调用成功
                    var options = $("#"+b).combobox('options');
                    options.textField = "APR_SHOWMSG";//必须要和数据库查询的字段一样(大小写敏感)
                    options.valueField = "APR_VALUE";
//加载数据
                    $("#"+b).combobox("loadData", response.body);
                }
            });
        }

        function  check(id) {
            if(id=='d1'){
                $('#consuLink_div').css("display",'none');
                $('#context_div').css("display",'block');
            }else if(id=='d2'){
                $('#consuLink_div').css("display",'block');
                $('#context_div').css("display",'none');
            }
        }
</script>
</body>
</html>