<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Editable Tree - jQuery EasyUI Demo</title>
    <link rel="stylesheet" type="text/css" href="../../easyui/1.3.4/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="../../easyui/1.3.4/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../../easyui/1.3.4/demo/demo.css">
    <link rel="stylesheet" href="../../kindeditor/themes/default/default.css" />
    <script type="text/javascript" src="../../js/jquery-1.8.0.min.js"></script>
    <script type="text/javascript" src="../../easyui/1.3.4/jquery.easyui.min.js"></script>
    <script src="../../kindeditor/kindeditor-all.js"></script>
    <script src="../../kindeditor/kindeditor-all-min.js"></script>
    <script charset="utf-8" src="../../kindeditor/lang/zh-CN.js"></script>
    <style>
        .uploadImgBtn {
            width: 100px;
            height: 100px;
            cursor: pointer;
            position: relative;
           /* //background: url("pk.jpg") no-repeat;*/
            -webkit-background-size: cover;
            background-size: cover;
        }

        .uploadImgBtn .uploadImg {
            position: absolute;
            right: 0;
            top: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .pic {
            width: 100px;
            height: 100px;
        }

        .pic img {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
<h2>Client Side Pagination in DataGrid</h2>
<div class="demo-info">
    <div class="demo-tip icon-tip"></div>
    <div>This sample shows how to implement client side pagination in DataGrid.</div>
</div>
<div style="margin:10px 0;">
    <form id="fm" method="post" style="margin-top: 20px; margin-left: 20px;" action="/management/consultation/updateConsultation">
        <input id="consulId" name="consulId"  type="hidden"  class="easyui-textbox" editable="false" />
        <div class="fitem">
            <label>所属菜单:</label>
            <input  id="columnId" name="columnId" style="" style="width: 160px; height: 65px;" class="easyui-combobox" editable="false"  data-options="required:true"/>
        </div>
        <input id ="images" name="images" type='hidden' class="easyui-textbox" editable="false" />
        <div class="fitem">
            <label>标题:</label>
            <input id="title" name="title" class="easyui-textbox" editable="false" />
        </div>

        <div class="fitem">
            <label>描述:</label>
            <input  id="consuDesc" name="consuDesc" class="easyui-textbox" editable="false" />
        </div>

        <div class="fitem">
            <label>类型:</label>
            <input  type="radio" name="consuType"
                    class="easyui-validatebox" checked="checked" value="0" onclick="check('d1')"><label>手动编辑</label></input>
            <input  type="radio" name="consuType"
                    class="easyui-validatebox" value="1" onclick="check('d2')"><label>外链</label></input>
        </div>

        <div class="fitem">
            <label>类别:</label>
            <input  id="consuClass" name="consuClass" style="width: 160px; height: 65px;" class="easyui-combobox" editable="false"  data-options="required:true"/>
        </div>
        <div class="fitem">
            <label>位置:</label>
            <input  id="consuPlace" name="consuPlace" style="width: 160px; height: 65px;" style="width: 160px; height: 65px;" class="easyui-combobox" editable="false"  data-options="required:true"/>
        </div>
        <div class="fitem" id="consuLink_div">
            <label>链接:</label>
            <input   id="consuLink" name="consuLink" style="width: 160px; height: 65px;" class="easyui-textbox" data-options="multiline:true" />
        </div>
        <div class="fitem" id="context_div">
            <label>文章内容:</label>
            <textarea rows="3" style="width:400px;" id="context" name="context" class="easyui-validatebox" data-options="required:true,validType:'length[1,1000000]'" invalidMessage="最大长度不能超过1000000"></textarea>
        </div>
        <div class="fitem">
            <label>备注:</label>
            <input  id="remarks"  name="remarks" style="width: 160px; height: 65px;" class="easyui-textbox" data-options="multiline:true" />
        </div>

    </form>
    <div id="formBox">
    </div>
    <div id="dlg-buttons1" style="display: block">
        <a id="confirm1" href="javascript:void(0)" class="easyui-linkbutton c6" iconcls="icon-ok" onclick="updateConsultation()" style="width: 90px">提交</a>
    </div>
</div>
<script>
        var editor;
        var count=0;
        $(function() {
            editor = KindEditor.create('textarea[name="context"]',{
                resizeType : 1,
                width:"100%",
                height:"200px",
                allowPreviewEmoticons:false,
                allowImageUpload:true,//允许上传图片
                allowFileManager:true, //允许对上传图片进行管理
                uploadJson:'/management/consultation/uploadImg.do', //上传图片的java代码，只不过放在jsp中
                fileManagerJson:'../../kindeditor/jsp/file_manager_json.jsp',
                afterUpload:function(){this.sync();}, //图片上传后，将上传内容同步到textarea中
                afterBlur:function(){this.sync();},   ////失去焦点时，将上传内容同步到textarea中
                items : [
                    'fontname','fontsize',
                    '|','forecolor',
                    'hilitecolor','bold',
                    'italic','underline',
                    'removeformat','|',
                    'justifyleft','justifycenter',
                    'justifyright','insertorderedlist',
                    'insertunorderedlist','|',
                    'emoticons','link','media','|','image'],
                afterChange:function(){
                    this.sync();
                },
                afterBlur:function(){
                    this.sync();
                }
            });
        var url = location.search;
        var consuId;
        if (url.indexOf("?") != -1) {
            var site = url.lastIndexOf("=");
            consuId=url.substring(site + 1, url.length);
        }
        voluation(consuId);
    });

    function voluation(consuId){
            alert(consuId);
        $.ajax({
            url:'/management/consultation/qryConsultationById',
            type:"POST",
            async:false,
            data:{consulId:consuId},
            success:function(data){
                /*return rows;*/
                alert(data);
                $("#columnId").val(data.columnId);
                $("#consulId").val(data.consulId);
                $("#title").val(data.title);
                $("#consuDesc").val(data.consuDesc);
                if (data.consuDesc == "00") {
                    $("input[name='consuDesc'][value='00']").attr("checked",true);
                    KindEditor.html("#context", data.context);
                    $('#consuLink_div').css("display",'none');
                }else if(data.consuDesc== "01"){
                    $("input[name='consuDesc'][value='01']").attr("checked",true);
                    $("#consuLink").val(data.consuLink);
                    $('#context_div').css("display",'none');
                }
                $("#consuType").val(data.consuType);
                $("#consuClass").val(data.consuClass);
                $("#consuPlace").val(data.consuPlace);
                $("#remarks").val(data.remarks);
                addForm(data.images);
            }
        });
    }

    function updateConsultation() {
        alert(count);
        var imageUrl='';
        alert( $(".uploadImg").length);
        for(var i=0;i<count-1;i++){
            alert($("#file"+i).val());
            var myDiv = document.getElementById("uploadImgBtn"+(i+1));
            if(myDiv==null){
                alert(1);
            }else{
                var style=myDiv.style;
                alert(style.backgroundImage.substring(5,style.backgroundImage.length-2));//red

                imageUrl+=style.backgroundImage.substring(5,style.backgroundImage.length-2)+',';
            }
        }
        alert(imageUrl.substring(0,imageUrl.length-1));
        $("#images").val(imageUrl.substring(0,imageUrl.length-1));
        fm.submit();
    }
    function addForm(images) {
        var img=[];
        img =images.split(",");
        count=img.length;
        for(var i=0;i<img.length;i++){
            var image = img[i];
            console.info(img)
            var str = '<form id="formTag'+(i+1)+'" enctype="multipart/form-data">'+
                '<div class="uploadImgBtn" id="uploadImgBtn'+(i+1)+'" style="background-image: url('+image+');">'+
                '<input class="uploadImg" type="file" name="file" id="file'+(i+1)+'">'+
                '</div>'+
                '</form>   ';

           /* var str='<form id="formTag1" enctype="multipart/form-data">'+
                '<div class="uploadImgBtn" id="uploadImgBtn1" style="background-image: url('+img+');">'+
                '<input class="uploadImg" type="file" name="file" id="file1">'+
                '</div>'+
                '</form>';*/
           /* $("#uploadImgBtn"+(i+1)).css({
                "background-image": "url("+img[i]+")"
            });*/
           /* var img_Url=img[i];
            alert("111111-"+img_Url);
            $("file"+(i+1)).parent().css({
                "background-image": "http://localhost:8001/management/Upload/201810/21-002318_6914_kpuhh9euE6.jpg"
            });*/
            $("#formBox").append($(str));
            $("#file"+(i+1)).on("change", upload );
        }
        var pk = 'http://localhost:8001/management/html/consultation/pk.jpg';
        var str1= '<form id="formTag'+(img.length+1)+'" enctype="multipart/form-data">'+
        '<div class="uploadImgBtn" style="background-image: url('+pk+')" id="uploadImgBtn'+(img.length+1)+'">'+
        '<input class="uploadImg" type="file" name="file" id="file'+(img.length+1)+'">'+
        '</div>'+
        '</form>   ';
        $("#formBox").append($(str1));
        var $sel = "#file"+(img.length+1);
        //为新生成的input绑定change事件
        $($sel).on("change", upload );
    }
        function upload(){
            var self = this;

            //获得它是第几个form表单
            var num = this.getAttribute("id").replace(/[a-zA-Z]/g,"");
            //构造form的选择器
            var $form = "#formTag" +num;
            alert("num++__+"+num);
            $.ajax({
                url:"/management/consultation/uploadImg.do",
                type:"post",
                dataType:"json",
                cache:false,
                data: new FormData($($form)[0]),
                processData: false,// 不处理数据
                contentType: false, // 不设置内容类型
                success:function(data){
                    //设置背景为我们选择的图片
                    $(self).parent().css({
                        "background-image": "url("+data.url+")"
                    });
                    //imgurl+=data.url;
                    // $("#images").val(imgurl);
                    //我们再生成一个form
                    if(count == num ){
                        //count计数加1
                        count +=1;
                        var str = '<form id="formTag'+count+'" enctype="multipart/form-data">'+
                            '<div class="uploadImgBtn" id="uploadImgBtn'+count+'">'+
                            '<input class="uploadImg" type="file" name="file" id="file'+count+'">'+
                            '</div>'+
                            '</form>   ';
                        //向最外面的盒子添加form
                        $("#formBox").append($(str));
                        //构造input的选择器
                        var $sel = "#file"+count;
                        //为新生成的input绑定change事件
                        $($sel).on("change", upload );

                    }else{
                        //如果不等于
                        return false;
                    }
                }
            });
        }
</script>
</body>
</html>